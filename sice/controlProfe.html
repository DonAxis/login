<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="botones.css">
  <link rel="stylesheet" href="Personas.css">
  <link rel="stylesheet" type="text/css" href="estiloProfe.css">
  <title>Panel de Profesor</title>
  
</head>
<body>

  <div class="header-profesor">
    <div>
      <h1>Panel de Profesor</h1>
      <p id="profesorInfo">Cargando...</p>
    </div>
    <div class="user-info">
      <p><strong id="userName">Cargando...</strong></p>
      <p id="userEmail"></p>
      <button id="btnVolverMenu" onclick="volverMenuProfe()" class="btn-config" style="display: none;">‚Üê Volver</button>
      <button id="btnVolverCoord" onclick="volverCoordinador()" class="btn-config" style="display: none;">Volver a Coordinador</button>
      <button onclick="mostrarConfiguracion()" class="btn-config">Configuraci√≥n</button>
      <button onclick="cerrarSesion()" class="btn-config">Cerrar Sesi√≥n</button>
    </div>
  </div>


  <!-- MODAL CONFIGURACI√ìN -->
  <div id="modalConfig" class="modal">
    <div class="modal-contenido">
      <span class="cerrar" onclick="cerrarModalConfig()">&times;</span>
      <h2>Configuraci√≥n</h2>
      
      <div style="margin: 20px 0;">
        <h3 style="color: #1976d2;">Cambiar Contrase√±a</h3>
        <form onsubmit="cambiarPassword(event)">
          <div class="form-grupo">
            <label>Contrase√±a Actual:</label>
            <input type="password" id="passwordActual" required minlength="6">
          </div>
          
          <div class="form-grupo">
            <label>Nueva Contrase√±a:</label>
            <input type="password" id="passwordNueva" required minlength="6">
          </div>
          
          <div class="form-grupo">
            <label>Confirmar Nueva Contrase√±a:</label>
            <input type="password" id="passwordConfirmar" required minlength="6">
          </div>
          
          <div class="form-botones">
            <button type="submit" class="btn-guardar">Cambiar Contrase√±a</button>
            <button type="button" onclick="cerrarModalConfig()" class="btn-cancelar">Cancelar</button>
          </div>
        </form>
      </div>

      <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
        <h3 style="color: #1976d2;">Informaci√≥n de la Cuenta</h3>
        <p><strong>Nombre:</strong> <span id="configNombre"></span></p>
        <p><strong>Email:</strong> <span id="configEmail"></span></p>
        <p><strong>Rol:</strong> Profesor</p>
        <p><strong>Carreras:</strong> <span id="configCarreras"></span></p>
      </div>
    </div>
  </div>

  <!-- MEN√ö PRINCIPAL PROFESOR -->
  <div class="menu-profesor">
    <div class="card-profesor" onclick="mostrarMisMaterias()">
      <h3>Mis Materias</h3>
      <p>Ver mis asignaciones y consultar calificaciones</p>
    </div>

    <div class="card-profesor" onclick="mostrarConfiguracion()">
      <h3>Configuraci√≥n</h3>
      <p>Ajustes de perfil y preferencias</p>
    </div>
  </div>

    <div class="card-profesor" onclick="verExtraordinarios()">
      <h3>Extraordinarios</h3>
      <p>Capturar extraordinarios y ETS</p>
  </div>

  <!-- SECCI√ìN: MIS MATERIAS -->
  <div id="seccionMaterias" class="seccion-contenido" style="display: none;">
    <div class="seccion-header">
      <h2 style="color: #6A2135; margin: 0;">Mis Materias</h2>
    </div>
    <div id="listaMaterias"></div>
  </div>

  <!-- SECCI√ìN: CALIFICACIONES -->
  <div id="seccionCalificaciones" class="seccion-contenido" style="display: none;">
    <div id="mensajeCalificaciones" style="background: #6a213455; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0c5460;">
      <strong>Instrucciones:</strong>  Una vez guardadas las calificaciones, solo el coordinador puede modificarlas.
    </div>
    <div class="seccion-header">
      <h2 style="color: #6A2135; margin: 0;">Calificaciones</h2>
    </div>
    <div id="infoMateriaActual" style="margin-bottom: 20px; padding: 15px; background: #f0f7ff; border-radius: 8px;"></div>
    <div id="tablaCalificaciones"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <script src="firebase.js"></script>


  <script>
    const auth = firebase.auth();
    let usuarioActual = null;

    // Protecci√≥n y autenticaci√≥n
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        console.log('No hay sesi√≥n activa');
        window.location.href = 'https://ilbcontrol.mx/sice/';
        return;
      }

      try {
        const userDoc = await db.collection('usuarios').doc(user.uid).get();
        
        if (!userDoc.exists) {
          console.log('Usuario no encontrado en Firestore');
          await auth.signOut();
          window.location.href = 'https://ilbcontrol.mx/sice/';
          return;
        }

        usuarioActual = userDoc.data();
        usuarioActual.uid = user.uid;

        console.log('Usuario cargado:', {
          nombre: usuarioActual.nombre,
          rol: usuarioActual.rol,
          esProfesor: usuarioActual.esProfesor,
          carreras: usuarioActual.carreras
        });

        // Auto-configurar si es coordinador sin carreras
        if (usuarioActual.rol === 'coordinador') {
          if (!usuarioActual.carreras && usuarioActual.carreraId) {
            usuarioActual.carreras = [usuarioActual.carreraId];
            db.collection('usuarios').doc(user.uid).update({
              carreras: [usuarioActual.carreraId]
            }).catch(err => console.log('No se pudo actualizar carreras:', err));
          }
          if (usuarioActual.esProfesor === undefined) {
            usuarioActual.esProfesor = true;
            db.collection('usuarios').doc(user.uid).update({
              esProfesor: true
            }).catch(err => console.log('No se pudo actualizar esProfesor:', err));
          }
        }

        // Verificar que sea profesor o coordinador-profesor
        if (usuarioActual.rol !== 'profesor' && 
            !(usuarioActual.rol === 'coordinador' && usuarioActual.esProfesor === true)) {
          console.log('No tienes permisos de profesor');
          console.log('Rol:', usuarioActual.rol, 'esProfesor:', usuarioActual.esProfesor);
          alert('No tienes permisos para acceder a este panel');
          window.location.href = 'https://ilbcontrol.mx/sice/';
          return;
        }

        const tipoUsuario = usuarioActual.rol === 'coordinador' ? 'Coordinador-Profesor' : 'Profesor';
        console.log(`${tipoUsuario} autorizado:`, usuarioActual.nombre);
        
        // Mostrar info del usuario
        document.getElementById('userName').textContent = usuarioActual.nombre;
        document.getElementById('userEmail').textContent = user.email;
        
        // Mostrar bot√≥n "Volver" si es coordinador
        if (usuarioActual.rol === 'coordinador') {
          document.getElementById('btnVolverCoord').style.display = 'inline-block';
        }
        
        // Cargar carreras
        await cargarInfoCarreras();
        
      } catch (error) {
        console.error('Error:', error);
        alert('Error al verificar permisos');
        window.location.href = 'https://ilbcontrol.mx/sice/';
      }
    });

    async function cargarInfoCarreras() {
      try {
        const infoElement = document.getElementById('profesorInfo');
        if (!infoElement) {
          console.log('Elemento profesorInfo no encontrado');
          return;
        }
        
        if (!usuarioActual.carreras || usuarioActual.carreras.length === 0) {
          infoElement.textContent = 'Sin carreras asignadas';
          return;
        }

        const nombresCarreras = [];
        for (const carrera of usuarioActual.carreras) {
          try {
            // Determinar el ID de la carrera
            let carreraId;
            if (typeof carrera === 'string') {
              // Array de strings simples
              carreraId = carrera;
            } else if (typeof carrera === 'object' && carrera.carreraId) {
              // Array de objetos {carreraId, color}
              carreraId = carrera.carreraId;
            } else {
              console.warn('Formato de carrera desconocido:', carrera);
              continue;
            }
            
            const doc = await db.collection('carreras').doc(carreraId).get();
            if (doc.exists) {
              nombresCarreras.push(doc.data().nombre);
            }
          } catch (err) {
            console.error('Error con carrera:', carrera, err);
          }
        }
        
        document.getElementById('profesorInfo').textContent = 
          nombresCarreras.length > 0 ? 'Carreras: ' + nombresCarreras.join(', ') : 'Sin carreras v√°lidas';
      } catch (error) {
        console.error('Error al cargar carreras:', error);
        document.getElementById('profesorInfo').textContent = 'Error al cargar carreras';
      }
    }

    function mostrarConfiguracion() {
      document.getElementById('configNombre').textContent = usuarioActual.nombre;
      document.getElementById('configEmail').textContent = usuarioActual.email;
      
      // Mostrar carreras
      db.collection('carreras').get().then(snapshot => {
        const carrerasMap = {};
        snapshot.forEach(doc => {
          carrerasMap[doc.id] = doc.data().nombre;
        });
        
        const nombresCarreras = usuarioActual.carreras
          .map(id => carrerasMap[id] || id)
          .join(', ');
        
        document.getElementById('configCarreras').textContent = nombresCarreras || 'Sin carreras';
      });
      
      document.getElementById('modalConfig').style.display = 'block';
    }

    function cerrarModalConfig() {
      document.getElementById('modalConfig').style.display = 'none';
      document.getElementById('passwordActual').value = '';
      document.getElementById('passwordNueva').value = '';
      document.getElementById('passwordConfirmar').value = '';
    }

    async function cambiarPassword(event) {
      event.preventDefault();
      
      const passwordActual = document.getElementById('passwordActual').value;
      const passwordNueva = document.getElementById('passwordNueva').value;
      const passwordConfirmar = document.getElementById('passwordConfirmar').value;
      
      // Validar que las contrase√±as coincidan
      if (passwordNueva !== passwordConfirmar) {
        alert('Las contrase√±as nuevas no coinciden');
        return;
      }
      
      // Validar longitud
      if (passwordNueva.length < 6) {
        alert('La contrase√±a debe tener al menos 6 caracteres');
        return;
      }
      
      try {
        const user = firebase.auth().currentUser;
        const credential = firebase.auth.EmailAuthProvider.credential(
          user.email,
          passwordActual
        );
        
        // Re-autenticar con contrase√±a actual
        await user.reauthenticateWithCredential(credential);
        
        // Cambiar contrase√±a
        await user.updatePassword(passwordNueva);
        
        alert('Contrase√±a cambiada. Recuerda mantenerla segura.');
        cerrarModalConfig();
        
      } catch (error) {
        console.error('Error al cambiar contrase√±a:', error);
        
        if (error.code === 'auth/wrong-password') {
          alert('La contrase√±a actual es incorrecta');
        } else if (error.code === 'auth/weak-password') {
          alert('La contrase√±a es muy d√©bil');
        } else {
          alert('Error al cambiar contrase√±a: ' + error.message);
        }
      }
    }

    async function cerrarSesion() {
      if (confirm('¬øCerrar sesi√≥n?')) {
        try {
          await auth.signOut();
          sessionStorage.clear();
          window.location.href = 'https://ilbcontrol.mx/sice/';
        } catch (error) {
          console.error('Error:', error);
          alert('Error al cerrar sesi√≥n');
        }
      }
    }

    // Volver al men√∫ principal
    function volverMenuProfe() {
      document.getElementById('seccionMaterias').style.display = 'none';
      document.getElementById('seccionCalificaciones').style.display = 'none';
      document.querySelector('.menu-profesor').style.display = 'grid';
      document.getElementById('btnVolverMenu').style.display = 'none'; // Ocultar bot√≥n
    }

    // Volver a coordinador
    function volverCoordinador() {
      window.location.href = 'controlCoordinador.html';
    }

    // Cerrar modal al hacer clic fuera
    window.onclick = function(event) {
      const modal = document.getElementById('modalConfig');
      if (event.target === modal) {
        cerrarModalConfig();
      }
    }

// =========================================
let asignacionActual = null;
let alumnosMateria = [];

// Mostrar materias asignadas al profesor
async function mostrarMisMaterias() {
  try {
    // Ocultar men√∫, mostrar materias
    document.querySelector('.menu-profesor').style.display = 'none';
    document.getElementById('seccionMaterias').style.display = 'block';
    
    const container = document.getElementById('listaMaterias');
    container.innerHTML = '<p style="text-align: center; color: #999;">Cargando materias...</p>';
    
    console.log('Buscando asignaciones para profesor:', usuarioActual.uid);
    
    // Buscar asignaciones del profesor
    const snapshot = await db.collection('profesorMaterias')
      .where('profesorId', '==', usuarioActual.uid)
      .where('activa', '==', true)
      .get();
    
    console.log('Asignaciones encontradas:', snapshot.size);
    
    if (snapshot.empty) {
      container.innerHTML = `
        <div style="text-align: center; padding: 60px 20px; max-width: 500px; margin: 0 auto;">
          <div style="font-size: 4rem; margin-bottom: 20px;"></div>
          <h3 style="color: #6A2135; margin-bottom: 10px;">No tienes materias asignadas</h3>
          <p style="color: #666; margin-bottom: 20px;">
            A√∫n no se te ha asignado ninguna materia para este periodo.
          </p>
          <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; border-left: 4px solid #6A2135;">
            <p style="margin: 0; color: #555;">
              <strong>¬øQu√© hacer?</strong><br>
              Contacta al coordinador de tu carrera para que te asigne materias y grupos.
            </p>
          </div>
        </div>
      `;
      return;
    }
    
    // Agrupar por periodo
    const asignacionesPorPeriodo = {};
    
    snapshot.forEach(doc => {
      const asignacion = { id: doc.id, ...doc.data() };
      const periodo = asignacion.periodo || 0;
      
      if (!asignacionesPorPeriodo[periodo]) {
        asignacionesPorPeriodo[periodo] = [];
      }
      asignacionesPorPeriodo[periodo].push(asignacion);
    });
    
    // Ordenar periodos
    const periodos = Object.keys(asignacionesPorPeriodo).map(p => parseInt(p)).sort((a, b) => a - b);
    
    let html = '<div style="display: grid; gap: 20px;">';
    
    periodos.forEach(periodo => {
      const asignaciones = asignacionesPorPeriodo[periodo];
      
      html += `
        <div>
          <h3 style="color: #6A2135; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #6A2135;">
            Periodo ${periodo} (${asignaciones.length} ${asignaciones.length === 1 ? 'materia' : 'materias'})
          </h3>
          <div style="display: grid; gap: 15px;">
      `;
      
      asignaciones.forEach(asignacion => {
        // Obtener nombre del turno
        const turnosNombres = {
          1: 'Matutino',
          2: 'Vespertino', 
          3: 'Nocturno',
          4: 'Sabatino'
        };
        const turnoNombre = asignacion.turnoNombre || turnosNombres[asignacion.turno] || 'Sin turno';
        
        html += `
          <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #6A2135; cursor: pointer; transition: all 0.3s; hover: transform: translateX(5px);" 
               onclick="verCalificacionesMateria('${asignacion.id}')">
            <h4 style="margin: 0 0 10px 0; color: #333; font-size: 1.1rem;">${asignacion.materiaNombre || 'Sin nombre'}</h4>
            <p style="margin: 5px 0; color: #666; font-size: 0.9rem;">
              <strong>C√≥digo Grupo:</strong> ${asignacion.codigoGrupo || 'N/A'} |
              <strong>Turno:</strong> ${turnoNombre} |
              <strong>Orden:</strong> ${asignacion.orden || 'N/A'}
            </p>
            <button style="background: #6A2135; color: white; border: none; padding: 8px 20px; border-radius: 5px; margin-top: 10px; cursor: pointer; font-weight: 600;">
              Ver Calificaciones ‚Üí
            </button>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    console.log('Materias cargadas correctamente');
    
  } catch (error) {
    console.error('Error al cargar materias:', error);
    alert('Error al cargar materias: ' + error.message);
  }
}

// Ver calificaciones de una materia espec√≠fica
async function verCalificacionesMateria(asignacionId) {
  try {
    console.log('Cargando calificaciones para asignaci√≥n:', asignacionId);
    
    // Cargar datos de la asignaci√≥n
    const asignacionDoc = await db.collection('profesorMaterias').doc(asignacionId).get();
    if (!asignacionDoc.exists) {
      alert('Asignaci√≥n no encontrada');
      return;
    }
    
    asignacionActual = {
      id: asignacionId,
      ...asignacionDoc.data()
    };
    
    console.log('Asignaci√≥n cargada:', asignacionActual);
    
    // Obtener nombre del turno
    const turnosNombres = {
      1: 'Matutino',
      2: 'Vespertino',
      3: 'Nocturno',
      4: 'Sabatino'
    };
    const turnoNombre = asignacionActual.turnoNombre || turnosNombres[asignacionActual.turno] || 'Sin turno';
    
    // Actualizar t√≠tulo
    const infoDiv = document.getElementById('infoMateriaActual');
    if (infoDiv) {
      infoDiv.innerHTML = `
        <h3 style="margin: 0 0 10px 0; color: #6A2135;">${asignacionActual.materiaNombre || 'Sin nombre'}</h3>
        <p style="margin: 0; color: #666;">
          <strong>Grupo:</strong> ${asignacionActual.codigoGrupo || 'N/A'} | 
          <strong>Turno:</strong> ${turnoNombre} |
          <strong>Periodo:</strong> ${asignacionActual.periodo || 'N/A'}
        </p>
      `;
    }
    
    // Cambiar vista
    document.querySelector('.menu-profesor').style.display = 'none';
    document.getElementById('seccionMaterias').style.display = 'none';
    document.getElementById('seccionCalificaciones').style.display = 'block';
    document.getElementById('btnVolverMenu').style.display = 'inline-block';
    
    // Cargar alumnos del grupo
    await cargarAlumnosYCalificaciones();
    
  } catch (error) {
    console.error('Error al cargar calificaciones:', error);
    alert('Error al cargar calificaciones: ' + error.message);
  }
}

// Cargar alumnos y sus calificaciones

async function cargarAlumnosYCalificaciones() {
  try {
    const container = document.getElementById('tablaCalificaciones');
    container.innerHTML = '<p style="text-align: center; color: #999;">Cargando alumnos...</p>';
    
    console.log('=== Cargando alumnos y calificaciones ===');
    console.log('Buscando alumnos del grupo:', asignacionActual.codigoGrupo);
    
    // Buscar alumnos del grupo
    const alumnosSnap = await db.collection('usuarios')
      .where('rol', '==', 'alumno')
      .where('codigoGrupo', '==', asignacionActual.codigoGrupo)
      .where('activo', '==', true)
      .get();
    
    console.log('Alumnos encontrados:', alumnosSnap.size);
    
    if (alumnosSnap.empty) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #999;">
          <p>No hay alumnos en este grupo.</p>
          <p style="font-size: 0.9rem; margin-top: 10px;">Grupo: ${asignacionActual.codigoGrupo}</p>
        </div>
      `;
      return;
    }
    
    alumnosMateria = [];
    
    // Cargar calificaciones existentes
    for (const doc of alumnosSnap.docs) {
      const alumno = {
        id: doc.id,
        ...doc.data(),
        calificaciones: {
          parcial1: null,
          parcial2: null,
          parcial3: null,
          falta1: null,
          falta2: null,
          falta3: null
        }
      };
      
      // Buscar calificaciones
      const docId = `${doc.id}_${asignacionActual.materiaId}`;
      const calDoc = await db.collection('calificaciones').doc(docId).get();
      
      if (calDoc.exists) {
        const data = calDoc.data();
        alumno.calificaciones.parcial1 = data.parciales?.parcial1 ?? null;
        alumno.calificaciones.parcial2 = data.parciales?.parcial2 ?? null;
        alumno.calificaciones.parcial3 = data.parciales?.parcial3 ?? null;
        alumno.calificaciones.falta1 = data.faltas?.falta1 ?? null;
        alumno.calificaciones.falta2 = data.faltas?.falta2 ?? null;
        alumno.calificaciones.falta3 = data.faltas?.falta3 ?? null;
      }
      
      alumnosMateria.push(alumno);
    }
    
    // Ordenar alfab√©ticamente
    alumnosMateria.sort((a, b) => a.nombre.localeCompare(b.nombre));
    
    console.log('Total alumnos cargados:', alumnosMateria.length);
    
    // Generar tabla
    generarTablaCalificaciones();
    
  } catch (error) {
    console.error('Error:', error);
    const container = document.getElementById('tablaCalificaciones');
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #dc3545;">
        <p><strong>Error al cargar alumnos</strong></p>
        <p style="font-size: 0.9rem;">${error.message}</p>
      </div>
    `;
  }
}

function generarTablaCalificaciones() {
  const container = document.getElementById('tablaCalificaciones');
  
  let html = `
    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #2196f3;">
      <strong>Instrucciones:</strong>
      <ul style="margin: 10px 0 0 20px; padding: 0;">
        <li>Las calificaciones y faltas <strong>NO se pueden modificar</strong> despu√©s de guardar</li>
        <li>Marca las faltas (0-20) en cada parcial</li>
        <li>Desliza horizontalmente en m√≥vil para ver todas las columnas</li>
      </ul>
    </div>
    
    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 15px 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <table style="width: 100%; min-width: 900px; border-collapse: collapse; background: white;">
        <thead style="background: linear-gradient(135deg, #6A2135 0%, #6A3221 100%); color: white;">
          <tr>
            <th rowspan="2" style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.2);">Alumno</th>
            <th rowspan="2" style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2); width: 100px;">Matr√≠cula</th>
            <th colspan="2" style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">Parcial 1</th>
            <th colspan="2" style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">Parcial 2</th>
            <th colspan="2" style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">Parcial 3</th>
            <th rowspan="2" style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2); width: 80px;">Promedio</th>
          </tr>
          <tr>
            <th style="padding: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.2); width: 70px;">Cal</th>
            <th style="padding: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,152,0,0.2); width: 60px;">Faltas</th>
            <th style="padding: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.2); width: 70px;">Cal</th>
            <th style="padding: 8px; text-align: center; border: 1px solid rgba(255,152,0,0.2); width: 60px;">Faltas</th>
            <th style="padding: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.2); width: 70px;">Cal</th>
            <th style="padding: 8px; text-align: center; border: 1px solid rgba(255,152,0,0.2); width: 60px;">Faltas</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  alumnosMateria.forEach((alumno, index) => {
    const cal = alumno.calificaciones;
    
    // Calcular promedio
    let promedio = null;
    let promedioTexto = '-';
    const tieneNP = cal.parcial1 === 'NP' || cal.parcial2 === 'NP' || cal.parcial3 === 'NP';
    
    if (tieneNP) {
      promedio = 5.0;
      promedioTexto = '5.0';
    } else {
      const cals = [cal.parcial1, cal.parcial2, cal.parcial3]
        .filter(c => c !== null && c !== undefined && c !== '' && c !== '-')
        .map(c => parseFloat(c))
        .filter(c => !isNaN(c));
      
      if (cals.length > 0) {
        promedio = cals.reduce((a, b) => a + b, 0) / cals.length;
        promedioTexto = promedio.toFixed(1);
      }
    }
    
    // Color del promedio
    let colorPromedio = '#666';
    if (promedio !== null) {
      if (promedio < 6) colorPromedio = '#dc3545';
      else if (promedio >= 8) colorPromedio = '#4caf50';
      else colorPromedio = '#ff9800';
    }
    
    html += `
      <tr style="border-bottom: 1px solid #eee;">
        <td style="padding: 12px; border: 1px solid #ddd; font-weight: 600;">${alumno.nombre || 'Sin nombre'}</td>
        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${alumno.matricula || 'N/A'}</td>
        
        <!-- PARCIAL 1 + FALTA 1 -->
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
          ${generarCeldaCalificacion(cal.parcial1, index, 'p1')}
        </td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #fff8e1;">
          ${generarCeldaFalta(cal.falta1, index, 'f1')}
        </td>
        
        <!-- PARCIAL 2 + FALTA 2 -->
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
          ${generarCeldaCalificacion(cal.parcial2, index, 'p2')}
        </td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #fff8e1;">
          ${generarCeldaFalta(cal.falta2, index, 'f2')}
        </td>
        
        <!-- PARCIAL 3 + FALTA 3 -->
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
          ${generarCeldaCalificacion(cal.parcial3, index, 'p3')}
        </td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #fff8e1;">
          ${generarCeldaFalta(cal.falta3, index, 'f3')}
        </td>
        
        <!-- PROMEDIO -->
        <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 1.1rem; background: #f0f7ff; color: ${colorPromedio};">
          ${promedioTexto}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
    
    <div style="text-align: center; color: #999; font-size: 0.85rem; margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 6px;">
      ‚Üê Desliza horizontalmente para ver todas las columnas ‚Üí
    </div>
    
    <button onclick="guardarCalificacionesProfe()" 
            style="background: linear-gradient(135deg, #6A2135 0%, #6A3221 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; width: 100%; max-width: 300px; margin: 20px auto; display: block;">
      Guardar Calificaciones
    </button>
  `;
  
  container.innerHTML = html;
  
  console.log('Tabla generada correctamente');
}
function generarCeldaCalificacion(valor, index, parcial) {
  if (valor !== null && valor !== undefined && valor !== '') {
    const color = valor === 'NP' ? '#dc3545' : '#4caf50';
    return `<span style="font-weight: bold; color: ${color};">${valor}</span>`;
  } else {
    return `
      <select id="cal_${index}_${parcial}" 
              style="width: 65px; padding: 6px; border: 2px solid #ddd; border-radius: 6px; text-align: center; font-weight: bold; font-size: 0.95rem;">
        <option value="">-</option>
        <option value="10">10</option>
        <option value="9">9</option>
        <option value="8">8</option>
        <option value="7">7</option>
        <option value="6">6</option>
        <option value="5">5</option>
        <option value="4">4</option>
        <option value="3">3</option>
        <option value="2">2</option>
        <option value="1">1</option>
        <option value="0">0</option>
        <option value="NP">NP</option>
      </select>
    `;
  }
}

// Guardar todas las calificaciones
function volverMenu() {
  document.getElementById('seccionMaterias').style.display = 'none';
  document.getElementById('seccionCalificaciones').style.display = 'none';
  document.querySelector('.menu-profesor').style.display = 'grid';
}
function generarCeldaFalta(valor, index, falta) {
  if (valor !== null && valor !== undefined && valor !== '') {
    const color = valor > 0 ? '#dc3545' : '#4caf50';
    return `<span style="font-weight: bold; color: ${color};">${valor}</span>`;
  } else {
    return `
      <input type="number" 
             id="fal_${index}_${falta}" 
             min="0" max="20" 
             value="0"
             placeholder="0"
             style="width: 50px; padding: 6px; border: 2px solid #ff9800; border-radius: 6px; text-align: center; font-weight: bold; font-size: 0.9rem;">
    `;
  }
}

function validarCalificacion(input) {
  const valor = parseFloat(input.value);
  
  if (isNaN(valor)) {
    return;
  }
  
  if (valor < 0 || valor > 10) {
    input.value = '';
    alert('La calificaci√≥n debe estar entre 0 y 10');
    return;
  }
  
  // Redondear a 1 decimal
  input.value = valor.toFixed(1);
}

function volverMaterias() {
  document.getElementById('seccionCalificaciones').style.display = 'none';
  document.getElementById('seccionMaterias').style.display = 'block';
  asignacionActual = null;
  alumnosMateria = [];
}

  </script>


<script>
// Funci√≥n para guardar calificaciones (solo las vac√≠as)
async function guardarCalificacionesProfe() {
  if (!confirm('¬øGuardar las calificaciones y faltas?\n\nIMPORTANTE: No podr√°s modificarlas despu√©s.')) {
    return;
  }
  
  console.log('=== Guardando calificaciones y faltas ===');
  console.log('Asignaci√≥n actual:', asignacionActual);
  
  try {
    let guardadas = 0;
    let errores = 0;
    const erroresDetalle = [];
    
    for (let i = 0; i < alumnosMateria.length; i++) {
      const alumno = alumnosMateria[i];
      
      console.log(`\nProcesando alumno: ${alumno.nombre}`);
      
      // ===== LEER VALORES DE LOS INPUTS =====
      
      // Parciales
      const inputP1 = document.getElementById(`cal_${i}_p1`);
      const inputP2 = document.getElementById(`cal_${i}_p2`);
      const inputP3 = document.getElementById(`cal_${i}_p3`);
      
      const p1 = inputP1 ? inputP1.value : '';
      const p2 = inputP2 ? inputP2.value : '';
      const p3 = inputP3 ? inputP3.value : '';
      
      // Faltas
      const inputF1 = document.getElementById(`fal_${i}_f1`);
      const inputF2 = document.getElementById(`fal_${i}_f2`);
      const inputF3 = document.getElementById(`fal_${i}_f3`);
      
      const f1 = inputF1 ? inputF1.value : '0';
      const f2 = inputF2 ? inputF2.value : '0';
      const f3 = inputF3 ? inputF3.value : '0';
      
      // Extraordinarios
      const inputExt = document.getElementById(`ext_${i}`);
      const inputEts = document.getElementById(`ets_${i}`);
      
      const ext = inputExt ? inputExt.value : '';
      const ets = inputEts ? inputEts.value : '';
      
      // ===== CONVERTIR A FORMATO CORRECTO =====
      
      const parcial1 = p1 === '' ? null : (p1 === 'NP' ? 'NP' : parseFloat(p1));
      const parcial2 = p2 === '' ? null : (p2 === 'NP' ? 'NP' : parseFloat(p2));
      const parcial3 = p3 === '' ? null : (p3 === 'NP' ? 'NP' : parseFloat(p3));
      
      const falta1 = f1 === '' ? 0 : parseInt(f1);
      const falta2 = f2 === '' ? 0 : parseInt(f2);
      const falta3 = f3 === '' ? 0 : parseInt(f3);
      
      const extraordinario = ext === '' ? null : parseFloat(ext);
      const etsCalif = ets === '' ? null : parseFloat(ets);
      
      console.log('  Parciales:', parcial1, parcial2, parcial3);
      console.log('  Faltas:', falta1, falta2, falta3);
      console.log('  Extraordinario:', extraordinario);
      console.log('  ETS:', etsCalif);
      
      // ===== VERIFICAR SI HAY NUEVOS DATOS =====
      
      const hayNuevasParciales = 
        (alumno.calificaciones.parcial1 === null && parcial1 !== null) ||
        (alumno.calificaciones.parcial2 === null && parcial2 !== null) ||
        (alumno.calificaciones.parcial3 === null && parcial3 !== null);
      
      const hayNuevasFaltas =
        (alumno.calificaciones.falta1 === null && falta1 !== null) ||
        (alumno.calificaciones.falta2 === null && falta2 !== null) ||
        (alumno.calificaciones.falta3 === null && falta3 !== null);
      
      const hayNuevosExtraordinarios =
        (alumno.calificaciones.extraordinario === null && extraordinario !== null) ||
        (alumno.calificaciones.ets === null && etsCalif !== null);
      
      if (!hayNuevasParciales && !hayNuevasFaltas && !hayNuevosExtraordinarios) {
        console.log('  -> Sin cambios, omitiendo');
        continue;
      }
      
      // ===== CARGAR CALIFICACIONES ACTUALES =====
      
      const docId = `${alumno.id}_${asignacionActual.materiaId}`;
      const calDoc = await db.collection('calificaciones').doc(docId).get();
      
      let datosActuales = {
        parciales: {
          parcial1: null,
          parcial2: null,
          parcial3: null
        },
        faltas: {
          falta1: null,
          falta2: null,
          falta3: null
        },
        extraordinario: null,
        ets: null
      };
      
      if (calDoc.exists) {
        const data = calDoc.data();
        datosActuales.parciales = data.parciales || datosActuales.parciales;
        datosActuales.faltas = data.faltas || datosActuales.faltas;
        datosActuales.extraordinario = data.extraordinario || null;
        datosActuales.ets = data.ets || null;
      }
      
      // ===== ACTUALIZAR SOLO LOS CAMPOS NUEVOS =====
      
      const nuevosParciales = {
        parcial1: datosActuales.parciales.parcial1 ?? parcial1,
        parcial2: datosActuales.parciales.parcial2 ?? parcial2,
        parcial3: datosActuales.parciales.parcial3 ?? parcial3
      };
      
      const nuevasFaltas = {
        falta1: datosActuales.faltas.falta1 ?? falta1,
        falta2: datosActuales.faltas.falta2 ?? falta2,
        falta3: datosActuales.faltas.falta3 ?? falta3
      };
      
      const nuevoExtraordinario = datosActuales.extraordinario ?? extraordinario;
      const nuevoEts = datosActuales.ets ?? etsCalif;
      
      // ===== CALCULAR PROMEDIO =====
      
      let promedio = null;
      const tieneNP = nuevosParciales.parcial1 === 'NP' || 
                      nuevosParciales.parcial2 === 'NP' || 
                      nuevosParciales.parcial3 === 'NP';
      
      if (tieneNP) {
        promedio = 5.0;
      } else {
        const cals = [
          nuevosParciales.parcial1, 
          nuevosParciales.parcial2, 
          nuevosParciales.parcial3
        ]
          .filter(c => c !== null && c !== undefined)
          .map(c => parseFloat(c))
          .filter(c => !isNaN(c));
        
        if (cals.length > 0) {
          promedio = cals.reduce((a, b) => a + b, 0) / cals.length;
        }
      }
      
      console.log('  Promedio calculado:', promedio);
      
      // ===== GUARDAR EN FIREBASE =====
      
      try {
        await db.collection('calificaciones').doc(docId).set({
          alumnoId: alumno.id,
          alumnoNombre: alumno.nombre,
          materiaId: asignacionActual.materiaId,
          materiaNombre: asignacionActual.materiaNombre,
          codigoGrupo: asignacionActual.codigoGrupo,
          profesorId: usuarioActual.uid,
          profesorNombre: usuarioActual.nombre,
          periodo: asignacionActual.periodo,
          carreraId: asignacionActual.carreraId,
          
          parciales: nuevosParciales,
          faltas: nuevasFaltas,
          extraordinario: nuevoExtraordinario,
          ets: nuevoEts,
          promedio: promedio,
          
          actualizadoPor: usuarioActual.uid,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        guardadas++;
        console.log('  ‚úì Guardado correctamente');
        
      } catch (error) {
        errores++;
        erroresDetalle.push(`${alumno.nombre}: ${error.message}`);
        console.error('  ‚úó Error al guardar:', error);
      }
    }
    
    console.log(`\n=== RESUMEN ===`);
    console.log(`Guardadas: ${guardadas}`);
    console.log(`Errores: ${errores}`);
    
    // ===== MOSTRAR RESULTADO =====
    
    if (errores > 0) {
      alert(
        `CALIFICACIONES GUARDADAS CON ERRORES\n\n` +
        `‚úì Guardadas: ${guardadas}\n` +
        `‚úó Errores: ${errores}\n\n` +
        `Errores:\n${erroresDetalle.join('\n')}`
      );
    } else if (guardadas > 0) {
      alert(
        `¬°CALIFICACIONES GUARDADAS!\n\n` +
        `‚úì ${guardadas} alumno(s) actualizado(s)\n\n` +
        `Las calificaciones y faltas han sido guardadas y no se pueden modificar.`
      );
      
      // Recargar datos
      await cargarAlumnosYCalificaciones();
    } else {
      alert('No hay calificaciones nuevas para guardar.');
    }
    
  } catch (error) {
    console.error('Error general:', error);
    alert('Error al guardar calificaciones: ' + error.message);
  }
}

/////////Extras reprobados
async function verExtraordinarios() {
  try {
    document.getElementById('menuMaterias').style.display = 'none';
    document.getElementById('seccionCalificaciones').style.display = 'block';
    document.getElementById('btnVolverMenu').style.display = 'inline-block';
    
    const container = document.getElementById('contenedorMateriaCalif');
    container.innerHTML = '<h2 style="color: #6A2135;">Extraordinarios y ETS</h2>';
    
    const tablaContainer = document.getElementById('tablaCalificaciones');
    tablaContainer.innerHTML = '<p style="text-align: center; color: #999;">Cargando materias...</p>';
    
    console.log('=== Cargando materias para extraordinarios ===');
    console.log('Profesor ID:', usuarioActual.uid);
    
    // Buscar todas las materias del profesor
    const asignacionesSnap = await db.collection('profesorMaterias')
      .where('profesorId', '==', usuarioActual.uid)
      .where('activa', '==', true)
      .get();
    
    console.log('Materias encontradas:', asignacionesSnap.size);
    
    if (asignacionesSnap.empty) {
      tablaContainer.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #999;">
          <p>No tienes materias asignadas</p>
        </div>
      `;
      return;
    }
    
    let html = `
      <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
        <strong>‚ö†Ô∏è Extraordinarios y ETS</strong>
        <p style="margin: 10px 0 0 0;">Solo se muestran los alumnos con promedio menor a 6 que requieren extraordinario.</p>
      </div>
    `;
    
    // Procesar cada materia
    for (const asigDoc of asignacionesSnap.docs) {
      const asignacion = { id: asigDoc.id, ...asigDoc.data() };
      
      console.log('\nProcesando materia:', asignacion.materiaNombre);
      
      // Buscar alumnos del grupo
      const alumnosSnap = await db.collection('usuarios')
        .where('rol', '==', 'alumno')
        .where('codigoGrupo', '==', asignacion.codigoGrupo)
        .where('activo', '==', true)
        .get();
      
      console.log('  Alumnos encontrados:', alumnosSnap.size);
      
      // Filtrar solo alumnos reprobados
      const alumnosReprobados = [];
      
      for (const alumnoDoc of alumnosSnap.docs) {
        const alumno = { id: alumnoDoc.id, ...alumnoDoc.data() };
        
        // Buscar calificaciones
        const docId = `${alumno.id}_${asignacion.materiaId}`;
        const calDoc = await db.collection('calificaciones').doc(docId).get();
        
        if (calDoc.exists) {
          const data = calDoc.data();
          const parciales = data.parciales || {};
          
          // Calcular promedio
          let promedio = null;
          const tieneNP = parciales.parcial1 === 'NP' || parciales.parcial2 === 'NP' || parciales.parcial3 === 'NP';
          
          if (tieneNP) {
            promedio = 5.0;
          } else {
            const cals = [parciales.parcial1, parciales.parcial2, parciales.parcial3]
              .filter(c => c !== null && c !== undefined)
              .map(c => parseFloat(c))
              .filter(c => !isNaN(c));
            
            if (cals.length > 0) {
              promedio = cals.reduce((a, b) => a + b, 0) / cals.length;
            }
          }
          
          // Solo agregar si est√° reprobado
          if (promedio !== null && promedio < 6) {
            alumnosReprobados.push({
              ...alumno,
              promedio,
              extraordinario: data.extraordinario,
              ets: data.ets,
              materiaId: asignacion.materiaId
            });
          }
        }
      }
      
      console.log('  Alumnos reprobados:', alumnosReprobados.length);
      
      // Solo mostrar la materia si tiene alumnos reprobados
      if (alumnosReprobados.length > 0) {
        html += `
          <div style="margin-bottom: 30px; border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="background: linear-gradient(135deg, #dc3545 0%, #c62828 100%); color: white; padding: 15px;">
              <div style="font-weight: 700; font-size: 18px;">${asignacion.materiaNombre}</div>
              <div style="font-size: 14px; opacity: 0.9;">
                Grupo: ${asignacion.codigoGrupo} | ${alumnosReprobados.length} alumno(s) reprobado(s)
              </div>
            </div>
            
            <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
              <table style="width: 100%; min-width: 600px; border-collapse: collapse;">
                <thead style="background: #f5f5f5;">
                  <tr>
                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Alumno</th>
                    <th style="padding: 12px; text-align: center; border: 1px solid #ddd; width: 100px;">Matr√≠cula</th>
                    <th style="padding: 12px; text-align: center; border: 1px solid #ddd; width: 80px;">Promedio</th>
                    <th style="padding: 12px; text-align: center; border: 1px solid #ddd; width: 100px; background: #fff3e0;">Extraordinario</th>
                    <th style="padding: 12px; text-align: center; border: 1px solid #ddd; width: 100px; background: #ffebee;">ETS</th>
                  </tr>
                </thead>
                <tbody>
        `;
        
        alumnosReprobados.forEach((alumno, index) => {
          const globalIndex = `${asigDoc.id}_${alumno.id}`;
          
          html += `
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 12px; border: 1px solid #ddd; font-weight: 600;">${alumno.nombre}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${alumno.matricula || 'N/A'}</td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center; color: #dc3545; font-weight: bold;">${alumno.promedio.toFixed(1)}</td>
              
              <!-- EXTRAORDINARIO -->
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #fff8e1;">
                ${alumno.extraordinario !== null && alumno.extraordinario !== undefined
                  ? `<span style="font-weight: bold; color: #4caf50;">${alumno.extraordinario}</span>`
                  : `<select id="ext_${globalIndex}" style="width: 70px; padding: 6px; border: 2px solid #ff9800; border-radius: 6px; text-align: center; font-weight: bold;">
                      <option value="">-</option>
                      <option value="10">10</option>
                      <option value="9">9</option>
                      <option value="8">8</option>
                      <option value="7">7</option>
                      <option value="6">6</option>
                      <option value="5">5</option>
                      <option value="4">4</option>
                      <option value="3">3</option>
                      <option value="2">2</option>
                      <option value="1">1</option>
                      <option value="0">0</option>
                    </select>`
                }
              </td>
              
              <!-- ETS -->
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #fce4ec;">
                ${alumno.ets !== null && alumno.ets !== undefined
                  ? `<span style="font-weight: bold; color: #4caf50;">${alumno.ets}</span>`
                  : `<select id="ets_${globalIndex}" style="width: 70px; padding: 6px; border: 2px solid #dc3545; border-radius: 6px; text-align: center; font-weight: bold;">
                      <option value="">-</option>
                      <option value="10">10</option>
                      <option value="9">9</option>
                      <option value="8">8</option>
                      <option value="7">7</option>
                      <option value="6">6</option>
                      <option value="5">5</option>
                      <option value="4">4</option>
                      <option value="3">3</option>
                      <option value="2">2</option>
                      <option value="1">1</option>
                      <option value="0">0</option>
                    </select>`
                }
              </td>
            </tr>
          `;
        });
        
        html += `
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
    }
    
    html += `
      <button onclick="guardarExtraordinarios()" 
              style="background: linear-gradient(135deg, #dc3545 0%, #c62828 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; width: 100%; max-width: 300px; margin: 20px auto; display: block;">
        üíæ Guardar Extraordinarios
      </button>
    `;
    
    tablaContainer.innerHTML = html;
    
    console.log('Extraordinarios cargados correctamente');
    
  } catch (error) {
    console.error('Error:', error);
    alert('Error al cargar extraordinarios: ' + error.message);
  }
}

// ===== FUNCI√ìN PARA GUARDAR EXTRAORDINARIOS =====

async function guardarExtraordinarios() {
  if (!confirm('¬øGuardar las calificaciones de Extraordinario y ETS?\n\nEstas calificaciones pueden ser modificadas despu√©s por el coordinador.')) {
    return;
  }
  
  try {
    let guardadas = 0;
    const elementos = document.querySelectorAll('[id^="ext_"], [id^="ets_"]');
    
    console.log('Elementos de extraordinarios encontrados:', elementos.length);
    
    for (const elem of elementos) {
      const valor = elem.value;
      if (valor === '' || valor === null) continue;
      
      const id = elem.id;
      const [tipo, ...partes] = id.split('_');
      const asignacionId = partes[0];
      const alumnoId = partes[1];
      
      const docId = `${alumnoId}_${asignacionId}`;
      
      console.log(`Guardando ${tipo} para documento: ${docId}`);
      
      const updateData = {
        actualizadoPor: usuarioActual.uid,
        fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      if (tipo === 'ext') {
        updateData.extraordinario = parseFloat(valor);
      } else if (tipo === 'ets') {
        updateData.ets = parseFloat(valor);
      }
      
      await db.collection('calificaciones').doc(docId).update(updateData);
      guardadas++;
    }
    
    if (guardadas > 0) {
      alert(`¬°Extraordinarios guardados!\n\n${guardadas} calificaci√≥n(es) actualizada(s).`);
      verExtraordinarios(); // Recargar
    } else {
      alert('No hay calificaciones nuevas para guardar.');
    }
    
  } catch (error) {
    console.error('Error:', error);
    alert('Error al guardar extraordinarios: ' + error.message);
  }
}



</script>
<script src="controlAlumnoEspecial.js"></script>

</body>
</html>